<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    #chat {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      width: 500px;
      height: 400px;
      overflow-y: auto;
      background-color: #fafafa;
      white-space: pre-wrap;
    }
    .user {
      background-color: #e0f7fa;
      padding: 8px;
      margin: 6px;
      border-radius: 10px;
      text-align: right;
    }
    .bot {
      background-color: #f1f8e9;
      padding: 8px;
      margin: 6px;
      border-radius: 10px;
      text-align: left;
    }
    .end {
      text-align: center;
      color: #888;
      margin-top: 10px;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h2>ğŸ’¬ LLM Chat (WebSocket)</h2>
  <div id="chat"></div>
  <textarea id="input" rows="3" cols="50" placeholder="Ask something..."></textarea><br>
  <button onclick="send()">Send</button>

  <script>
    // const ws = new WebSocket("ws://localhost:8000/ws");
    const ws = new WebSocket("ws://192.168.219.44:8000/ws");
    const chat = document.getElementById("chat");
    let currentBotDiv = null;

    ws.onopen = () => console.log("Connected to backend");

    ws.onmessage = (event) => {
      const data = event.data.trim();

      // ë‹µë³€ ëë‚¬ìŒì„ ì•Œë¦¬ëŠ” ë©”ì‹œì§€
      if (data === "[end of response]") {
        currentBotDiv = null; // ë‹¤ìŒ ì§ˆë¬¸ì— ëŒ€ë¹„
        const endDiv = document.createElement("div");
        endDiv.className = "end";
        endDiv.textContent = "â€•â€• End of Response â€•â€•";
        chat.appendChild(endDiv);
        chat.scrollTop = chat.scrollHeight;
        return;
      }



      // JSON íŒŒì‹±
      try {
        const json = JSON.parse(data);

        if (json.message && json.message.content) {
          appendToBotMessage(json.message.content);
        }

        else if (json.response) {
          appendToBotMessage(json.response);
        }
      } catch {
        appendToBotMessage(event.data);
      }
    };

    ws.onclose = () => console.log("Disconnected from server");

    function send() {
      const msg = document.getElementById("input").value.trim();
      if (!msg) return;

      addUserMessage(msg);  // ìƒˆë¡œìš´ ìœ ì € ë°•ìŠ¤
      ws.send(msg);
      document.getElementById("input").value = "";

      // ì§ˆë¬¸ í•˜ë‚˜ì— ëŒ€í•œ ìƒˆë¡œìš´ bot ë°•ìŠ¤ ìƒì„±
      currentBotDiv = document.createElement("div");
      currentBotDiv.className = "bot";
      chat.appendChild(currentBotDiv);
      chat.scrollTop = chat.scrollHeight;
    }

    function addUserMessage(text) {
      const div = document.createElement("div");
      div.className = "user";
      div.textContent = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function appendToBotMessage(text) {
      if (!currentBotDiv) return; // í˜¹ì‹œ send ì „ì— ë©”ì‹œì§€ ì˜¤ë©´ ë¬´ì‹œ
      currentBotDiv.textContent += text;
      chat.scrollTop = chat.scrollHeight;
    }
  </script>
</body>
</html>
